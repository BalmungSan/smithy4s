"use strict";(self.webpackChunksmithy4s=self.webpackChunksmithy4s||[]).push([[444],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return d}});var o=n(7294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,s=function(e,t){if(null==e)return{};var n,o,s={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var a=o.createContext({}),p=function(e){var t=o.useContext(a),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return o.createElement(a.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,s=e.mdxType,r=e.originalType,a=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),d=s,h=u["".concat(a,".").concat(d)]||u[d]||m[d]||r;return n?o.createElement(h,i(i({ref:t},c),{},{components:n})):o.createElement(h,i({ref:t},c))}));function d(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=n.length,i=new Array(r);i[0]=u;var l={};for(var a in t)hasOwnProperty.call(t,a)&&(l[a]=t[a]);l.originalType=e,l.mdxType="string"==typeof e?e:s,i[1]=l;for(var p=2;p<r;p++)i[p]=n[p];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},674:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return a},default:function(){return d},frontMatter:function(){return l},metadata:function(){return p},toc:function(){return m}});var o=n(7462),s=n(3366),r=(n(7294),n(3905)),i=["components"],l={sidebar_label:"Compliance Tests",title:"Compliance Tests"},a=void 0,p={unversionedId:"protocols/compliance-tests",id:"protocols/compliance-tests",title:"Compliance Tests",description:"The Smithy prelude has support for compliance testing for services that use HTTP as their protocol. It is built on top of regular traits, you can read more about it over here.",source:"@site/../docs/target/jvm-2.13/mdoc/03-protocols/05-compliance-tests.md",sourceDirName:"03-protocols",slug:"/protocols/compliance-tests",permalink:"/smithy4s/docs/protocols/compliance-tests",draft:!1,editUrl:"https://github.com/disneystreaming/smithy4s/edit/main/modules/docs/src/03-protocols/05-compliance-tests.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_label:"Compliance Tests",title:"Compliance Tests"},sidebar:"tutorialSidebar",previous:{title:"Deriving CLIs",permalink:"/smithy4s/docs/protocols/deriving-cli"},next:{title:"Customisation",permalink:"/smithy4s/docs/codegen/customisation"}},c={},m=[{value:"Example specification",id:"example-specification",level:2},{value:"Testing the protocol",id:"testing-the-protocol",level:2}],u={toc:m};function d(e){var t=e.components,n=(0,s.Z)(e,i);return(0,r.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"The Smithy prelude has support for compliance testing for services that use ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP")," as their protocol. It is built on top of regular traits, you can read more about it ",(0,r.kt)("a",{parentName:"p",href:"https://awslabs.github.io/smithy/2.0/additional-specs/http-protocol-compliance-tests.html"},"over here"),"."),(0,r.kt)("p",null,"Basically, you annotate operations and/or structures (that depends on the type of test being defined) and protocol implementors can generate tests cases to ensure their implementation behaves correctly."),(0,r.kt)("p",null,"Smithy4s publishes a module that you can use to write compliance test if you're implementing a protocol. Add the following to your dependencies if you use ",(0,r.kt)("inlineCode",{parentName:"p"},"sbt"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-scala"},'"com.disneystreaming.smithy4s" %% "smithy4s-compliance-tests" % smithy4sVersion.value\n')),(0,r.kt)("p",null,"If you use ",(0,r.kt)("inlineCode",{parentName:"p"},"mill"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-scala"},'ivy"com.disneystreaming.smithy4s::smithy4s-compliance-tests:${smithy4sVersion()}",\n')),(0,r.kt)("p",null,"The rest of this document will demonstrate how to write a Smithy specification that specify HTTP compliance tests, and then how to use the module mentioned above to run the tests."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Note: currently, only ",(0,r.kt)("inlineCode",{parentName:"em"},"httprequesttests-trait")," are supported. other traits support will be integrated soon.")),(0,r.kt)("h2",{id:"example-specification"},"Example specification"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-kotlin"},'$version: "2"\n\nnamespace smithy4s.hello\n\nuse smithy4s.api#simpleRestJson\nuse smithy.test#httpRequestTests\n\n@simpleRestJson\nservice HelloWorldService {\n  version: "1.0.0",\n  operations: [Hello]\n}\n@httpRequestTests([\n    {\n        id: "hello-success"\n        protocol: simpleRestJson\n        method: "POST"\n        uri: "/World"\n        params: { name: "World" }\n    },\n    {\n        id: "hello-fails"\n        protocol: simpleRestJson\n        method: "POST"\n        uri: "/fail"\n        params: { name: "World" }\n    }\n])\n@http(method: "POST", uri: "/{name}", code: 200)\noperation Hello {\n  input := {\n    @httpLabel\n    @required\n    name: String\n  },\n  output := {\n    @required\n    message: String\n  }\n}\n')),(0,r.kt)("p",null,"We have a very simple specification: one operation with basic input and output shapes. We've added a ",(0,r.kt)("inlineCode",{parentName:"p"},"httpRequestTests")," to define a compliance test for protocol implementors."),(0,r.kt)("h2",{id:"testing-the-protocol"},"Testing the protocol"),(0,r.kt)("p",null,"The service in the specification is annotated with the ",(0,r.kt)("inlineCode",{parentName:"p"},"simpleRestJson")," protocol definition. We'll use the ",(0,r.kt)("inlineCode",{parentName:"p"},"compliance-tests")," module to make sure this protocol can handle such an operation."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Note: the following code and the ",(0,r.kt)("inlineCode",{parentName:"em"},"compliance-tests")," module do not depend on a specific test framework. If you want to hook it into your test framework, it is easy to do so but it's outside the scope of this document. Refer to ",(0,r.kt)("a",{parentName:"em",href:"https://github.com/disneystreaming/smithy4s/blob/main/modules/compliance-tests/test/src/smithy4s/compliancetests/WeaverComplianceTest.scala"},"this example")," to see how we did it for ",(0,r.kt)("inlineCode",{parentName:"em"},"Weaver")," in this project.")),(0,r.kt)("p",null,"First, some imports:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-scala"},"import cats.effect._\nimport org.http4s._\nimport org.http4s.client.Client\nimport smithy4s.compliancetests._\nimport smithy4s.example._\nimport smithy4s.http4s._\nimport smithy4s.Service\n")),(0,r.kt)("p",null,"Then, you can create and instance of ",(0,r.kt)("inlineCode",{parentName:"p"},"ClientHttpComplianceTestCase")," and/or ",(0,r.kt)("inlineCode",{parentName:"p"},"ServerHttpComplianceTestCase")," while selecting the protocol to use and the service to test:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-scala"},'val clientTestGenerator = new ClientHttpComplianceTestCase[\n    smithy4s.api.SimpleRestJson,\n    HelloWorldServiceGen,\n    HelloWorldServiceOperation\n  ](\n    smithy4s.api.SimpleRestJson()\n  ) {\n    import org.http4s.implicits._\n    private val baseUri = uri"http://localhost/"\n    def getClient(app: HttpApp[IO]): Resource[IO, HelloWorldService[IO]] =\n      SimpleRestJsonBuilder(HelloWorldServiceGen)\n        .client(Client.fromHttpApp(app))\n        .uri(baseUri)\n        .resource\n    def codecs = SimpleRestJsonBuilder.codecs\n  }\n\nval serverTestGenerator = new ServerHttpComplianceTestCase[\n    smithy4s.api.SimpleRestJson,\n    HelloWorldServiceGen,\n    HelloWorldServiceOperation\n  ](\n    smithy4s.api.SimpleRestJson()\n  ) {\n    def getServer[Alg2[_[_, _, _, _, _]], Op2[_, _, _, _, _]](\n      impl: smithy4s.Monadic[Alg2, IO]\n  )(implicit s: Service[Alg2, Op2]): Resource[IO, HttpRoutes[IO]] =\n      SimpleRestJsonBuilder(s).routes(impl).resource\n    def codecs = SimpleRestJsonBuilder.codecs\n  }\n\nval tests: List[ComplianceTest[IO]] = clientTestGenerator.allClientTests() ++ serverTestGenerator.allServerTests()\n')),(0,r.kt)("p",null,"Now, you can iterate over the test cases and do what you want. This is where you would hook in the test framework of your choice, but in the following example, we're just going to print the result:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-scala"},'import cats.syntax.traverse._\nimport cats.effect.unsafe.implicits.global\n\nval runTests: IO[List[String]] = tests\n  .map { tc =>\n    tc.run.map {\n      case Left(value) =>\n        s"Failed ${tc.name} with the following message: $value"\n      case Right(_) => s"Success ${tc.name}"\n\n    }\n  }\n  .sequence\n')),(0,r.kt)("p",null,"Will produce the following when executed:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Success smithy4s.example#Hello(client|request): helloSuccess\nFailed smithy4s.example#Hello(client|request): helloFails with the following message: Actual value: http://localhost/World was not equal to http://localhost/fail.\nSuccess smithy4s.example#Hello(server|request): helloSuccess\nFailed smithy4s.example#Hello(server|request): helloFails with the following message: Actual value: HelloInput(World) was not equal to HelloInput(fail).\n")))}d.isMDXComponent=!0}}]);