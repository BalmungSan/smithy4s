"use strict";(self.webpackChunksmithy4s=self.webpackChunksmithy4s||[]).push([[314],{3905:function(e,t,r){r.d(t,{Zo:function(){return d},kt:function(){return m}});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=n.createContext({}),p=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},d=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),u=p(r),m=a,h=u["".concat(s,".").concat(m)]||u[m]||c[m]||o;return r?n.createElement(h,l(l({ref:t},d),{},{components:r})):n.createElement(h,l({ref:t},d))}));function m(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,l=new Array(o);l[0]=u;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:a,l[1]=i;for(var p=2;p<o;p++)l[p]=r[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,r)}u.displayName="MDXCreateElement"},4857:function(e,t,r){r.r(t),r.d(t,{assets:function(){return d},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return i},metadata:function(){return p},toc:function(){return c}});var n=r(7462),a=r(3366),o=(r(7294),r(3905)),l=["components"],i={sidebar_label:"Client",title:"SimpleRestJson client"},s=void 0,p={unversionedId:"protocols/simple-rest-json/client",id:"protocols/simple-rest-json/client",title:"SimpleRestJson client",description:"The smithy4s-http4s module provides functions that transform low-level http4s clients into high-level stubs, provided the corresponding service definitions (in smithy) are annotated with the alloy#simpleRestJson protocol.",source:"@site/../docs/target/jvm-2.13/mdoc/03-protocols/02-simple-rest-json/03-client.md",sourceDirName:"03-protocols/02-simple-rest-json",slug:"/protocols/simple-rest-json/client",permalink:"/smithy4s/docs/protocols/simple-rest-json/client",draft:!1,editUrl:"https://github.com/disneystreaming/smithy4s/edit/main/modules/docs/src/03-protocols/02-simple-rest-json/03-client.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_label:"Client",title:"SimpleRestJson client"},sidebar:"tutorialSidebar",previous:{title:"Server",permalink:"/smithy4s/docs/protocols/simple-rest-json/server"},next:{title:"Openapi",permalink:"/smithy4s/docs/protocols/simple-rest-json/openapi"}},d={},c=[{value:"Error Handling",id:"error-handling",level:2},{value:"X-Error-Type",id:"x-error-type",level:4},{value:"Status Code",id:"status-code",level:4}],u={toc:c};function m(e){var t=e.components,r=(0,a.Z)(e,l);return(0,o.kt)("wrapper",(0,n.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"smithy4s-http4s")," module provides functions that transform low-level http4s clients into high-level stubs, provided the corresponding service definitions (in smithy) are annotated with the ",(0,o.kt)("inlineCode",{parentName:"p"},"alloy#simpleRestJson")," protocol."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Uri is optional as it will default to http://localhost:8080"),(0,o.kt)("li",{parentName:"ul"},"the max arity of json array decoder is 1024 by default, but can be changed by calling withMaxArity on the RestJsonBuilder object")),(0,o.kt)("p",null,"In ",(0,o.kt)("inlineCode",{parentName:"p"},"build.sbt")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-scala"},'libraryDependencies ++= Seq(\n  // version sourced from the plugin\n  "com.disneystreaming.smithy4s"  %% "smithy4s-http4s" % smithy4sVersion.value\n)\n')),(0,o.kt)("p",null,"In ",(0,o.kt)("inlineCode",{parentName:"p"},"Clients.scala")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-scala"},'import smithy4s.http4s._\nimport org.http4s.Uri\nimport org.http4s.client.Client\nimport cats.effect.IO\nimport cats.effect.Resource\n\n// the package under which the scala code was generated\nimport smithy4s.hello._\n\nobject Clients {\n  def helloWorldClient2(http4sClient: Client[IO]) : Resource[IO, HelloWorldService[IO]] =\n    SimpleRestJsonBuilder\n      .withMaxArity(2048) // prepare maximum array/object size accepted during json decoding\n      .apply(HelloWorldService)\n      .client(http4sClient)\n      .uri(Uri.unsafeFromString("http://localhost"))\n      .resource\n\n}\n')),(0,o.kt)("h2",{id:"error-handling"},"Error Handling"),(0,o.kt)("p",null,"Smithy4s clients map HTTP error responses to the errors defined in the underlying smithy model in the following ways:"),(0,o.kt)("h4",{id:"x-error-type"},"X-Error-Type"),(0,o.kt)("p",null,"If an ",(0,o.kt)("inlineCode",{parentName:"p"},"X-Error-Type")," header is present on the response from the server, the value of this header is used to map the response to a specific error type.\nThe header's value can be either the ShapeId of the error it is targeting OR the name without the namespace. The value of this header is case sensitive.\nHere are some examples of an X-Error-Type header:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"X-Error-Type: NotFoundError")," AND ",(0,o.kt)("inlineCode",{parentName:"p"},"X-Error-Type: example.test#NotFoundError")," could each be used to map to the error type ",(0,o.kt)("inlineCode",{parentName:"p"},"NotFoundError"),". This of course assumes\nthat the ",(0,o.kt)("inlineCode",{parentName:"p"},"NotFoundError")," is provided in either the service or operation ",(0,o.kt)("inlineCode",{parentName:"p"},"errors")," array provided in the smithy model."),(0,o.kt)("p",null,"All smithy4s services provide an ",(0,o.kt)("inlineCode",{parentName:"p"},"X-Error-Type")," in responses by default."),(0,o.kt)("h4",{id:"status-code"},"Status Code"),(0,o.kt)("p",null,"If the ",(0,o.kt)("inlineCode",{parentName:"p"},"X-Error-Type")," header is not defined, smithy4s clients will use the status code to attempt to decide which error type to utilize. It does so as follows:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"If there is a single Error type that contains the correct status code in the ",(0,o.kt)("inlineCode",{parentName:"li"},"httpError")," trait, this type will be used. If there are two error types with the same status code, an ",(0,o.kt)("inlineCode",{parentName:"li"},"UnknownErrorResponse")," will be surfaced to the client."),(0,o.kt)("li",{parentName:"ol"},"If there is NOT a matching status code, but there is a single error marked with the ",(0,o.kt)("inlineCode",{parentName:"li"},"error")," trait, this error type will be used as long as the returned status code is in the range for either a client or server error. In other words if a single error shape has no status code, but is annotated with ",(0,o.kt)("inlineCode",{parentName:"li"},'@error("client")')," and the returned status code is 404 then this error type will be used. If there are multiple error types with no status code and a matching error type (client/server), then an ",(0,o.kt)("inlineCode",{parentName:"li"},"UnknownErrorResponse")," will be surfaced to the client.")),(0,o.kt)("p",null,"Here are some examples to show more what this looks like."),(0,o.kt)("p",null,"Example smithy model:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},'operation TestOp {\n  ...\n  errors: [NotFoundError, ServiceUnavailableError, CatchAllClientError, CatchAllServerError]\n}\n\n@httpError(404)\n@error("client")\nstructure NotFoundError {\n  message: String\n}\n\n@httpError(503)\n@error("server")\nstructure ServiceUnavailableError {\n  message: String\n}\n\n@error("client")\nstructure CatchAllClientError {\n  message String\n}\n\n@error("server")\nstructure CatchAllServerError {\n  message String\n}\n')),(0,o.kt)("p",null,"And here are some scenarios using this example model. For all of these, assume that NO ",(0,o.kt)("inlineCode",{parentName:"p"},"X-Error-Type")," header is provided."),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Status Code"),(0,o.kt)("th",{parentName:"tr",align:null},"Error Selected"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"404"),(0,o.kt)("td",{parentName:"tr",align:null},"NotFoundError")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"400"),(0,o.kt)("td",{parentName:"tr",align:null},"CatchAllClientError")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"503"),(0,o.kt)("td",{parentName:"tr",align:null},"ServiceUnavailableError")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"500"),(0,o.kt)("td",{parentName:"tr",align:null},"CatchAllServerError")))),(0,o.kt)("p",null,"However, adding another error to the operation that looks like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},'@error("client")\nstructure AnotherError {\n  message: String\n}\n')),(0,o.kt)("p",null,"Would result in the following:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Status Code"),(0,o.kt)("th",{parentName:"tr",align:null},"Error Selected"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"404"),(0,o.kt)("td",{parentName:"tr",align:null},"NotFoundError")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"400"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("strong",{parentName:"td"},"UnknownErrorResponse"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"503"),(0,o.kt)("td",{parentName:"tr",align:null},"ServiceUnavailableError")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"500"),(0,o.kt)("td",{parentName:"tr",align:null},"CatchAllServerError")))),(0,o.kt)("p",null,"Notice that the 400 status code cannot be properly mapped. This is because there is no exact match AND there are two errors that are labeled with ",(0,o.kt)("inlineCode",{parentName:"p"},'@error("client")')," which also do not have an associated ",(0,o.kt)("inlineCode",{parentName:"p"},"httpError")," trait containing a status code."),(0,o.kt)("p",null,"Adding another error type to the operation that looks like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},'@httpError(404)\n@error("client")\nstructure AnotherNotFoundError {\n  message: String\n}\n')),(0,o.kt)("p",null,"Will result in the following:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Status Code"),(0,o.kt)("th",{parentName:"tr",align:null},"Error Selected"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"404"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("strong",{parentName:"td"},"UnknownErrorResponse"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"400"),(0,o.kt)("td",{parentName:"tr",align:null},"UnknownErrorResponse")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"503"),(0,o.kt)("td",{parentName:"tr",align:null},"ServiceUnavailableError")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"500"),(0,o.kt)("td",{parentName:"tr",align:null},"CatchAllServerError")))),(0,o.kt)("p",null,"Now the 404 status code cannot be mapped. This is due to the fact that two different error types are annotated with a 404 ",(0,o.kt)("inlineCode",{parentName:"p"},"httpError")," trait. This means that the smithy4s\nclient is not able to decide which of these errors is correct."))}m.isMDXComponent=!0}}]);