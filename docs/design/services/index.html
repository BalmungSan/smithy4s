<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<title data-react-helmet="true">Services and endpoints | smithy4s</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://disneystreaming.github.io/smithy4s/docs/design/services"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Services and endpoints | smithy4s"><meta data-react-helmet="true" name="description" content="In addition to relying heavily on a Schema construct, which enables abstracting over serialisation, Smithy4s uses abstractions to codify the notion of interface, to allow for interoperability with various communication protocols. The idea is to reason generically about things of this shape :"><meta data-react-helmet="true" property="og:description" content="In addition to relying heavily on a Schema construct, which enables abstracting over serialisation, Smithy4s uses abstractions to codify the notion of interface, to allow for interoperability with various communication protocols. The idea is to reason generically about things of this shape :"><link data-react-helmet="true" rel="icon" href="/smithy4s/img/favicon-32x32.png"><link data-react-helmet="true" rel="canonical" href="https://disneystreaming.github.io/smithy4s/docs/design/services"><link data-react-helmet="true" rel="alternate" href="https://disneystreaming.github.io/smithy4s/docs/design/services" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://disneystreaming.github.io/smithy4s/docs/design/services" hreflang="x-default"><link rel="stylesheet" href="/smithy4s/assets/css/styles.19e462f2.css">
<link rel="preload" href="/smithy4s/assets/js/runtime~main.db4f80df.js" as="script">
<link rel="preload" href="/smithy4s/assets/js/main.499c23c0.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/smithy4s/"><div class="navbar__logo"><img src="/smithy4s/img/logo.svg" alt="Disney Streaming Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/smithy4s/img/logoDark.svg" alt="Disney Streaming Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">smithy4s</b></a><a class="navbar__item navbar__link navbar__link--active" href="/smithy4s/docs/overview/intro">Get Started</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/disneystreaming/smithy4s" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/smithy4s/docs/overview/intro">Overview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/smithy4s/docs/the-smithy-idl/smithy-idl">The Smithy IDL</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/smithy4s/docs/protocols/protocols">Protocols</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/smithy4s/docs/codegen/customisation">Code generation</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/smithy4s/docs/design/design">Design</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/smithy4s/docs/design/design">General design principles</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/smithy4s/docs/design/schemas">Datatypes and schemas</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/smithy4s/docs/design/services">Services and endpoints</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Services and endpoints</h1></header><p>In addition to relying heavily on a <code>Schema</code> construct, which enables abstracting over serialisation, Smithy4s uses abstractions to codify the notion of interface, to allow for interoperability with various communication protocols. The idea is to reason generically about things of this shape :</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">trait Interface[Context[_]]{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def operation1(a: A, b: B) : Context[Output1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def operation2(c: C, d: D, e: E) : Context[Output2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This generalisation enables the easy interpretation of implementations of such interfaces into services (HTTP, RPC, etc), or conversely, the derivation of stub instances of these interfaces to talk to remote services.</p><p>The creation of an abstraction that allows for this generalisation is a problem similar to the one that lead to the <code>Schema</code> construct : one needs to deconstruct the notion of &quot;interface&quot; into fundamental building blocks.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="the-duality-of-final-and-initial-algebras">The duality of final and initial algebras<a class="hash-link" href="#the-duality-of-final-and-initial-algebras" title="Direct link to heading">â€‹</a></h2><p>Before we dive into the core of the solution, one notion that is drastically helpful is the duality between finally-encoded algebras and initially-encoded algebras.</p><ul><li><p>Finally-encoded algebras are object-oriented encodings of a set of operations, just like above : operations are represented as <strong>methods</strong> in an interface. Interpretation of expressions written in terms of these methods does not involve any runtime transformation from one context to another : the method call is merely executed. In other words, when they are executed, expressions coming from finally-encoded algebras are already in their &quot;final form&quot;.</p></li><li><p>Conversely, initially-encoded algebras represent expressions as <strong>data</strong>, implying that interpretation involves a transformation of this data into lower level method calls. However, <strong>data</strong> has the quality of being a first class construct in programming languages, meaning you can pass it around and use it as parameter to functions. This allows for the unification of code-paths, as the differences between some aspects of a bit of logic can be absorbed by the data and handled later on.</p></li></ul><p>Finally-encoded KVStore algebra :</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">trait KVStore[Context[_]]{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def put(key: String, value: String) : Context[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def get(key: String)                : Context[Option[String]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def delete(key: String)             : Context[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Initially-encoded KVStore algebra :</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">sealed trait KVStoreOp[Output]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object KVStoreOp {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case class Put(key: String, value: String)  extends KVStore[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case class Get(key: String)                 extends KVStore[Option[String]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case class Delete(key: String)              extends KVStore[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>These two encodings contain a similar amount of information. It is nearly-trivial to go from a <code>KVstore[Context]</code> instance to a <code>KVStoreOp ~&gt; Context</code> natural transformation, and vice versa:</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">trait ~&gt;[F[_], G[_]]{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def apply[A](fa: F[A]) : G[A]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def asNaturalTransformation[Context[_]](impl: KVStore[Context]) = new (KVStoreOp ~&gt; Context){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def apply[A](fa: KVStoreOp[A]) : Context[A] = fa match {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case KVStoreOp.Put(key, value) =&gt; impl.put(key, value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case KVStoreOp.Get(key)        =&gt; impl.get(key)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case KVStoreOp.Delete(key)     =&gt; impl.delete(key)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def fromNaturalTransformation[Context[_]](run: KVStoreOp ~&gt; Context) = new KVStore[Context]{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def put(key: String, value: String) = run(KVStoreOp.Put(key, value))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def get(key: String)                = run(KVStoreOp.Get(key))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def delete(key: String)             = run(KVStoreOp.Delete(key))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This duality is heavily used by Smithy4s : finally-encoded interfaces are generally more natural to Scala developers, and are better supported in editors (autocompletion, etc). But from an implementation&#x27;s perspective, the initial, data-based encoding is really interesting, because operations are reified as <strong>data-types</strong> that can be associated with instances of generic type-classes : it is possible to abstract over data, it is not possible to abstract over method calls.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="a-detour-around-kinds">A detour around kinds<a class="hash-link" href="#a-detour-around-kinds" title="Direct link to heading">â€‹</a></h3><p>The methods generated by Smithy4s are conceptually similar to the methods expressed in the example above, except that the output types are significantly more verbose.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">trait Interface[Context[_, _, _, _, _,]]{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def operation1(a: A, b: B) : Context[Input, Error, Output, StreamedInput, StreamedOutput]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Let&#x27;s address this awkwardness right away, by explaining the rationale behind this seemingly humongous signature :</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="input">Input<a class="hash-link" href="#input" title="Direct link to heading">â€‹</a></h4><p>It&#x27;s the input type of an operation. Typically, a case class that holds fields matching the method parameters. We keep track of it in the return type for several reasons:</p><ul><li>In the internal logic of Smithy4s, It prevents having to prematurely shoe-horn kinds into other kinds by means of injection/projection, which helps both implementor and compiler alike</li><li>It will come in handy for the implementation of some pagination-aware interpreters, as pagination typically works by performing a modification of the previous input in order to get the next batch (page) of results. This implies that the input (and therefore its type) must be tracked across several requests resulting from a single method call.</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="error">Error<a class="hash-link" href="#error" title="Direct link to heading">â€‹</a></h4><p>The execution of an operation can result in errors. The Smithy language allows for tying a list of errors to operations. When generating the associated code, Smithy4s synthesize a union. This allows the coproduct of errors associated to an operation to be represented as a bona fide Scala type, which we can abstract over via some type-class instance. This is also very useful for the writing of bi-functor interpreters, for users that are interested in this kind of UX.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="output">Output<a class="hash-link" href="#output" title="Direct link to heading">â€‹</a></h4><p>No surprise there : this is the data resulting from the run of the operation.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="streamedinput-streamedoutput">StreamedInput, StreamedOutput<a class="hash-link" href="#streamedinput-streamedoutput" title="Direct link to heading">â€‹</a></h4><p>Smithy supports the concept of <a href="https://awslabs.github.io/smithy/1.0/spec/core/stream-traits.html?highlight=streaming#streaming-trait" target="_blank" rel="noopener noreferrer">Streaming</a>. It is communicated as a trait that annotates a single field of the input shape or/and output shape of an operation. Scala does not have a &quot;standard&quot; way of expressing streaming semantics. Moreover, streaming constructs in Scala are heavily context dependant. It is therefore impossible for us to incorporate the concept of &quot;streaming&quot; to our <code>Schema</code> construct as it is meant to be context-free and third-party-free.</p><p>To get some intuition for why that is : say we want to express streaming using <a href="https://github.com/typelevel/fs2/" target="_blank" rel="noopener noreferrer">fs2</a>. If we naively generate a case class that has one of its fields annotated with <code>@streaming</code>, it means that the the field is of type <code>fs2.Stream[F, A]</code>, which means that we either need to make a decision on what the <code>F</code> is, which is not okay for obvious reasons, or we need to propagate the <code>F[_]</code> type parameter upward to the case class. Now our <code>Schema</code> value, which accompanies the case-class, also have to carry the <code>F</code> ... this propagates throughout the whole codebase. We deemed that not acceptable.</p><p>Rather than polluting all layers of abstraction, we decided to just have the concept of operation be impacted and hold the streamed type in a separate type parameter. This allows for interpreters from various ecosystem to emerge. It also has the quality of allowing users to access the unary component of outputs (ie, data that is communicated in the headers of HTTP responses) without necessarily allocating resources to consume the streamed component of the output.</p><p>NB: at the time of writing this, Smithy4s does not have any streaming-aware interpreter implemented. But streaming is such a fundamental notion in remote interactions, and we had to devise a plan to ensure that third parties could decide to implement interpreters without waiting.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="transformation">Transformation<a class="hash-link" href="#transformation" title="Direct link to heading">â€‹</a></h3><p>Because of the complex kinds we&#x27;re dealing with, we codify a natural-transformation, called <code>Smithy4s.Transformation</code> that allows us to work at this level :</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">trait Transformation[F[_, _, _, _, _], G[_, _, _, _, _]] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def apply[I, E, O, SI, SO](fa: F[I, E, O, SI, SO]): G[I, E, O, SI, SO]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This is a mouthful, but conceptually, it&#x27;s exactly the same as our good old polymorphic function typically aliased to <code>~&gt;</code>.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="codifying-the-duality-between-initial-and-final-algebras">Codifying the duality between initial and final algebras<a class="hash-link" href="#codifying-the-duality-between-initial-and-final-algebras" title="Direct link to heading">â€‹</a></h3><p>What we want users to manipulate is the final-encoded version of a service: a good-old object-oriented interface that has decent editor support. But we need the initial-encoded version to implement interpreters in a generic fashion.</p><p>So we codify the duality to allow for switching from one to the other via an abstraction called <code>Smithy4s.Service</code>, which is the entry point to all interpreters.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">trait Service[Final[_[_, _, _, _, _]], Initial[_, _, _, _, _]] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def asTransformation[F[_, _, _, _, _,]](alg: Final[F]) : Transformation[Initial, F]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def transform[F[_, _, _, _, _]](transformation: Transformation[Initial, F]) : Final[F]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Implementations of such interfaces are code-generated. This implies that any smithy <code>Service</code> shape gets translated as a finally-encoded interface, but also as an initially-encoded <code>GADT</code></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="the-high-level-philosophy-of-smithy4s">The high-level philosophy of Smithy4s<a class="hash-link" href="#the-high-level-philosophy-of-smithy4s" title="Direct link to heading">â€‹</a></h2><p>The goal of Smithy4s is to allow users to derive client stubs and routers in various protocols, by running the generated code (or instances of generated interfaces) in some one-liner functions. To that end, Smithy4s surfaces a number of abstractions (such as <code>smithy4s.schema.Schema</code>) that allow for the implementation of (very) polymorphic interpreters. These interpreters operate on the generated code, which reflects what the user defines in their smithy Specs.</p><p>The abstractions used by interpreters contain all the elements that allow for turning a high-level method call (from an interface generated by Smithy4s) into a low level request of some sort, and then transform a low level response into the output of the method call.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="logical-flow-client-side">Logical flow: client-side<a class="hash-link" href="#logical-flow-client-side" title="Direct link to heading">â€‹</a></h3><p>Conceptually, to derive a high-level client that uses some sort of <code>Request =&gt; Response</code> protocol, the implementation has to follow a sequence of steps:</p><ol><li>Assuming this method call : <code>kvstore.get(&quot;key&quot;)</code></li><li>turning the method call into a piece of data : <code>KVStoreOp.Get(&quot;key&quot;)</code> using the initially-encoded dual of the <code>KVStore</code> interface</li><li>Retrieving the Smithy4s <code>Schemas</code> (input and output) associated to the <code>Get</code> operation</li><li>Compiling the schema associated to the input of the <code>Get</code> operation into some encoding function : <code>GetInput =&gt; Request</code></li><li>Running the request through a low-level <code>Request =&gt; Response</code> function (like an HTTP client)</li><li>Running <code>Get</code> into some function that gives us its <code>GetInput</code> representation</li><li>Compiling the schema associated to the output (<code>GetOutput</code> ~= <code>Option[String]</code>) of the <code>Get</code> operation into some decoding function <code>Response =&gt; Output</code></li></ol><p>So we get <code>kvstore.get =&gt; KVStoreOp.Get =&gt; GetInput =&gt; Request =&gt; Response =&gt; GetOutput</code>, which gives us the full data flow, client side.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="logical-flow-server-side">Logical flow: server-side<a class="hash-link" href="#logical-flow-server-side" title="Direct link to heading">â€‹</a></h3><p>The server side is different in that we want to derive the <code>Request =&gt; Response</code> function from an instance of our interface (<code>KVStore</code>). The goal is to mechanically translate a request into a method call, and a method&#x27;s output into a response. The sequence:</p><ol><li>From a given <code>Request</code>, find the corresponding operation <code>Op</code> (for instance, by means of HTTP path). Let&#x27;s assume it&#x27;s the <code>get</code> operation,</li><li>Retrieve the Smithy4s <code>Schemas</code> (input and output) associated to the operation (<code>KVStoreOp.Get</code>)</li><li>Compile a <code>Request =&gt; GetInput</code> decoding function, and run the <code>Request</code> through it</li><li>From <code>GetInput</code>, recreate the <code>KVStoreOp.Get</code> instance</li><li>From <code>KVStoreOp.Get</code>, use the final-encoded dual of <code>KVStoreOp</code> to call the <code>KVStore#get</code> method (implemented by the user). This gets us an <code>GetOutput</code></li><li>Compile a <code>GetOutput =&gt; Response</code> encoding function from the schemas, and run the output through it</li></ol><p>So we get <code>Request =&gt; KVStoreOp.GetInput =&gt; KVStoreOp.Get =&gt; kvstore.get =&gt; GetOutput =&gt; Response</code>, which gives us the full data flow, service side.</p><p>Both the service-side and client-side logical flows guide the design of the abstractions that are exposed by Smithy4s.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="a-note-about-efficiency">A note about efficiency<a class="hash-link" href="#a-note-about-efficiency" title="Direct link to heading">â€‹</a></h3><p>The flows described above are merely conceptual, and do not account for the optimisations involved to ensure that schemas are not recompiled into codecs on a per-request basis (which would greatly impact performance). Interpreters provided by Smithy4s (HTTP and co) are written to ensure that all compilation is performed ahead of receiving requests, by means of preliminary computations and caching.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="the-endpoint-abstraction">The Endpoint abstraction<a class="hash-link" href="#the-endpoint-abstraction" title="Direct link to heading">â€‹</a></h2><p>The <code>smithy4s.Endpoint</code> abstraction ties a specific operation to the various schemas that are tied to it.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">trait Endpoint[Initial[_, _, _, _, _], I, E, O, SI, SO] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def shapeId : ShapeId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def hints: Hints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def input: Schema[I]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def output: Schema[O]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def streamedInput: StreamingSchema[SI]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def streamedOutput: StreamingSchema[SO]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def wrap(input: I): Initial[I, E, O, SI, SO]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def errorable: Option[Errorable[E]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Endpoints are not type-classes. Instead, the <code>Endpoint</code> trait is extended by the companion object of each member of the <code>GADT</code> forming the initial-encoding of the service interface. So, going back to our <code>KVStore</code>, the corresponding sealed-trait would look like this :</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">sealed trait KVStoreOp[Input, Error, Output, StreamedInput, StreamedOutput]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>and the <code>put</code> operation would look like :</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">case class Put(input: PutRequest) extends KVStoreOp[PutRequest, PutError, PutResult, Nothing, Nothing]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object Put extends Endpoint[KVStoreOp, PutRequest, PutError, PutResult, Nothing, Nothing] with Errorable[PutError]{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val input = PutRequest.input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val output = PutRequest.input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val streamedInput = SteamingSchema.nothing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val streamedOutput = StreamingSchema.nothing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val errorable: Option[Errorable[PutResult]] = this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="a-note-on-errors">A note on errors<a class="hash-link" href="#a-note-on-errors" title="Direct link to heading">â€‹</a></h3><p>As stated previously, Smithy4s generates a coproduct type for each operation, where the members of the coproduct point to the various errors listed in the smithy operation shape. Additionally, each structure annotated with <code>@error</code> in smithy is rendered as a case-class that extends <code>Throwable</code>, because <code>Throwables</code> are the de-facto standard of doing error handling on the JVM. Even libraries that use <code>Either</code> to perform error handling often represent the left-hand-side of the Either as some throwable type, to facilitate the absorption of errors into the error-channels of monadic constructs (<code>IO.raiseError</code>, etc)</p><p>As a result, it is important for Smithy4s to expose functions that generically enable the filtering of throwables against the <code>Error</code> type parameter of an operation, so that interpreters can intercept errors and apply the correct encoding (dictated via <code>Schema</code>) before communicating them back to the caller over the wire. Conversely, it is important to expose a function that allows to go from the generic <code>Error</code> type parameter to <code>Throwable</code>, so that errors received via low-level communication channels can be turned into <code>Throwable</code> at the client call site, in order to populate the relevant error channel when exposing mono-functor semantics.</p><p>Therefore, when a smithy operation has <code>errors</code> defined, the corresponding <code>smithy4s.Endpoint</code> also extends the <code>Errorable</code> interface, which looks like this :</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">trait Errorable[E] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def error: UnionSchema[E]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def liftError(throwable: Throwable): Option[E]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def unliftError(e: E): Throwable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="services-and-endpoints">Services and endpoints<a class="hash-link" href="#services-and-endpoints" title="Direct link to heading">â€‹</a></h2><p>In order to implement any server-side interpreters, it is required to have a list of endpoints. That list is used to implement some matching logic based on the <code>shapeId</code> and/or the <code>hints</code> associated to the endpoints, in order to deterministically decide where to route a low level <code>Request</code> to a specific <code>Endpoint</code> instance.</p><p>For instance, smithy provides a <code>@http</code> trait out of the box that can annotate operations :</p><div class="codeBlockContainer_J+bg language-kotlin theme-code-block"><div class="codeBlockContent_csEI kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">service KVStore {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  operations: [Get, Put]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@http(method: &quot;GET&quot;, uri: &quot;/resource/${key}, code: 200)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">operation Get {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input: GetInput</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output: GetOutput</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">structure GetInput {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @httpLabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key: String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">structure GetOutput {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value: String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@http(method: &quot;PUT&quot;, uri: &quot;/resource/${key}, code: 200)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">operation Put {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">structure PutInput {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @httpLabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key: String,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @httpPayload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value: String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Each <code>@http</code> occurrence get translated to a scala value in the <code>Hints</code> associated to the corresponding endpoint.</p><ul><li>On server-side, having a list of all the endpoints associated to a service allows for creating a routing logic that dispatches an HTTP Request to the correct endpoint.</li><li>On client-side, a method call to a service stub gets translated to an instance of the corresponding <code>GADT</code> member. From there, we have to retrieve the schemas associated to the member in question. Additionally, we need to extract the input value out of the member, to run it through an encoder derived from the the associated <code>Schema</code>.</li></ul><p>Therefore, the <code>Service</code> abstraction needs to be enriched with the following methods :</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">trait Service[Final[_[_, _, _, _, _]], Initial[_, _, _, _, _]] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // useful for server-side</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def endpoints: List[Endpoint[Initial, _, _, _, _, _]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // useful for client-side</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def endpoint[I, E, O, SI, SO](op: Initial[I, E, O, SI, SO]): (I, Endpoint[Initial, I, E, O, SI, SO])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="conclusion-and-complete-interfaces">Conclusion and complete interfaces<a class="hash-link" href="#conclusion-and-complete-interfaces" title="Direct link to heading">â€‹</a></h2><p>Here are links to the complete interfaces discussed in this chapter.</p><ul><li><a href="https://github.com/disneystreaming/smithy4s/blob/main/modules/core/src/smithy4s/Service.scala" target="_blank" rel="noopener noreferrer">Service</a></li><li><a href="https://github.com/disneystreaming/smithy4s/blob/main/modules/core/src/smithy4s/Endpoint.scala" target="_blank" rel="noopener noreferrer">Endpoint</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/disneystreaming/smithy4s/edit/main/modules/docs/src/05-design/03-services.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/smithy4s/docs/design/schemas"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Datatypes and schemas</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-duality-of-final-and-initial-algebras" class="table-of-contents__link toc-highlight">The duality of final and initial algebras</a><ul><li><a href="#a-detour-around-kinds" class="table-of-contents__link toc-highlight">A detour around kinds</a></li><li><a href="#transformation" class="table-of-contents__link toc-highlight">Transformation</a></li><li><a href="#codifying-the-duality-between-initial-and-final-algebras" class="table-of-contents__link toc-highlight">Codifying the duality between initial and final algebras</a></li></ul></li><li><a href="#the-high-level-philosophy-of-smithy4s" class="table-of-contents__link toc-highlight">The high-level philosophy of Smithy4s</a><ul><li><a href="#logical-flow-client-side" class="table-of-contents__link toc-highlight">Logical flow: client-side</a></li><li><a href="#logical-flow-server-side" class="table-of-contents__link toc-highlight">Logical flow: server-side</a></li><li><a href="#a-note-about-efficiency" class="table-of-contents__link toc-highlight">A note about efficiency</a></li></ul></li><li><a href="#the-endpoint-abstraction" class="table-of-contents__link toc-highlight">The Endpoint abstraction</a><ul><li><a href="#a-note-on-errors" class="table-of-contents__link toc-highlight">A note on errors</a></li></ul></li><li><a href="#services-and-endpoints" class="table-of-contents__link toc-highlight">Services and endpoints</a></li><li><a href="#conclusion-and-complete-interfaces" class="table-of-contents__link toc-highlight">Conclusion and complete interfaces</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/smithy4s/docs/overview/intro">Get Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/disneystreaming/smithy4s" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Disney Streaming</div></div></div></footer></div>
<script src="/smithy4s/assets/js/runtime~main.db4f80df.js"></script>
<script src="/smithy4s/assets/js/main.499c23c0.js"></script>
</body>
</html>