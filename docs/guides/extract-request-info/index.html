<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<title data-react-helmet="true">Extracting Request Information | smithy4s</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://disneystreaming.github.io/smithy4s/docs/guides/extract-request-info"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Extracting Request Information | smithy4s"><meta data-react-helmet="true" name="description" content="There are times where the implementation of your route handlers may require more information from the underlying http4s request."><meta data-react-helmet="true" property="og:description" content="There are times where the implementation of your route handlers may require more information from the underlying http4s request."><link data-react-helmet="true" rel="icon" href="/smithy4s/img/favicon-32x32.png"><link data-react-helmet="true" rel="canonical" href="https://disneystreaming.github.io/smithy4s/docs/guides/extract-request-info"><link data-react-helmet="true" rel="alternate" href="https://disneystreaming.github.io/smithy4s/docs/guides/extract-request-info" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://disneystreaming.github.io/smithy4s/docs/guides/extract-request-info" hreflang="x-default"><link rel="stylesheet" href="/smithy4s/assets/css/styles.27d6adb7.css">
<link rel="preload" href="/smithy4s/assets/js/runtime~main.6c96914a.js" as="script">
<link rel="preload" href="/smithy4s/assets/js/main.5e422d53.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/smithy4s/"><div class="navbar__logo"><img src="/smithy4s/img/logo.svg" alt="Disney Streaming Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/smithy4s/img/logoDark.svg" alt="Disney Streaming Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">smithy4s</b></a><a class="navbar__item navbar__link navbar__link--active" href="/smithy4s/docs/overview/intro">Get Started</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/disneystreaming/smithy4s" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/smithy4s/docs/overview/intro">Overview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/smithy4s/docs/the-smithy-idl/smithy-idl">The Smithy IDL</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/smithy4s/docs/protocols/protocols">Protocols</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/smithy4s/docs/codegen/customisation">Code generation</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/smithy4s/docs/design/design">Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/smithy4s/docs/guides/extract-request-info">Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/smithy4s/docs/guides/extract-request-info">Extracting Request Info</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Extracting Request Information</h1></header><p>There are times where the implementation of your route handlers may require more information from the underlying http4s request.
You may want to store the raw request, check the request body against an HMAC value, pass along header values for tracing spans, etc.</p><p>When possible, the implementation of things like this should be isolated to middleware and not passed into the route handlers themselves.
However, there are times where this isn&#x27;t possible. This guide shows you how to implement a middleware that uses <code>IOLocal</code> to pass the value
of several headers from the request into the smithy4s route handlers.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="what-is-iolocal">What is IOLocal?<a class="hash-link" href="#what-is-iolocal" title="Direct link to heading">â€‹</a></h2><p><a href="https://github.com/typelevel/cats-effect/blob/series/3.x/core/shared/src/main/scala/cats/effect/IOLocal.scala" target="_blank" rel="noopener noreferrer">IOLocal</a>
is a construct that allows for sharing context across the scope of a <code>Fiber</code>. This means it allows you to get and set some value <code>A</code> in the <code>IOLocal</code>.
This value will be accessible across the current <code>Fiber</code>. As a <code>Fiber</code> is forked into new fibers, the value of <code>A</code> is carried over to the new <code>Fiber</code>.
However, the new <code>Fiber</code> will not be able to update the value kept on its parent or sibling fibers.</p><p>This diagram, adapted from the <a href="https://github.com/typelevel/cats-effect/blob/series/3.x/core/shared/src/main/scala/cats/effect/IOLocal.scala" target="_blank" rel="noopener noreferrer">IOLocal docs</a>, illustrates this well:</p><p><img alt="IOLocal flow chart" src="/smithy4s/assets/images/ioLocalDiagram-8b535a4e121c2cb02f518e0f0eccaac3.svg"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="example-implementation">Example Implementation<a class="hash-link" href="#example-implementation" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="smithy-spec">Smithy Spec<a class="hash-link" href="#smithy-spec" title="Direct link to heading">â€‹</a></h3><p>For this example, we are going to be working with the following smithy specification (taken from <a href="https://github.com/disneystreaming/smithy4s/blob/main/sampleSpecs/hello.smithy" target="_blank" rel="noopener noreferrer">smithy4s repo</a>):</p><div class="codeBlockContainer_J+bg language-kotlin theme-code-block"><div class="codeBlockContent_csEI kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">namespace smithy4s.hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use smithy4s.api#simpleRestJson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@simpleRestJson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service HelloWorldService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version: &quot;1.0.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Indicates that all operations in `HelloWorldService`,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // here limited to Hello, can return `GenericServerError`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  errors: [GenericServerError],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  operations: [Hello]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@error(&quot;server&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@httpError(500)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">structure GenericServerError {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  message: String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@http(method: &quot;POST&quot;, uri: &quot;/{name}&quot;, code: 200)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">operation Hello {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input: Person</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output: Greeting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">structure Person {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @httpLabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @required</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">structure Greeting {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @required</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  message: String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>See our <a href="/smithy4s/docs/overview/intro">getting started documentation</a> for instructions on how to use this specification to generate scala code.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="service-implementation">Service Implementation<a class="hash-link" href="#service-implementation" title="Direct link to heading">â€‹</a></h3><p>Let&#x27;s start by creating a case class that we will use to hold the value of some headers from our request.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">case class RequestInfo(contentType: String, userAgent: String)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This class will give us a spot to place the <code>Content-Type</code> and <code>User-Agent</code> headers, respectively. These are just shown
as an example. We could instead pass any other header or part of the request.</p><p>From here, we can implement the <code>HelloWorldService</code> interface that smithy4s generated from the specification above.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import smithy4s.hello._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import cats.effect.IO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import cats.effect.IOLocal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final class HelloWorldServiceImpl(requestInfo: IO[RequestInfo]) extends HelloWorldService[IO] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def hello(name: String, town: Option[String]): IO[Greeting] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestInfo.flatMap { reqInfo: RequestInfo =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      IO.println(&quot;REQUEST_INFO: &quot; + reqInfo)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .as(Greeting(s&quot;Hello, $name&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This is a basic implementation that, in addition to returning a <code>Greeting</code>, prints the <code>RequestInfo</code> out to the console.
Note that it is getting the <code>RequestInfo</code> from the <code>IO[RequestInfo] that is being passed in as a constructor parameter. This </code>IO<code>will be created using the same</code>IOLocal<code>instance is passed to our middleware implementation.
That way, the middleware can set the</code>RequestInfo` value that we are reading here.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="middleware">Middleware<a class="hash-link" href="#middleware" title="Direct link to heading">â€‹</a></h3><p>Below is the middleware implementation. It extracts the <code>Content-Type</code> and <code>User-Agent</code> headers and passes them along in the <code>IOLocal</code>
instance it is provided.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import cats.data._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.http4s.HttpRoutes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import cats.syntax.all._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.http4s.headers.{`Content-Type`, `User-Agent`}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object Middleware {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def withRequestInfo(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      routes: HttpRoutes[IO],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      local: IOLocal[Option[RequestInfo]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ): HttpRoutes[IO] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HttpRoutes[IO] { request =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      val requestInfo = for {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        contentType &lt;- request.headers.get[`Content-Type`].map(ct =&gt; s&quot;${ct.mediaType.mainType}/${ct.mediaType.subType}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        userAgent &lt;- request.headers.get[`User-Agent`].map(_.product.toString)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } yield RequestInfo(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        contentType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        userAgent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      OptionT.liftF(local.set(requestInfo)) *&gt; routes(request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="wiring-it-together">Wiring it Together<a class="hash-link" href="#wiring-it-together" title="Direct link to heading">â€‹</a></h3><p>Now that we have our service implementation and our middleware, we need to combine them to create our application.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import cats.effect.kernel.Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object Routes {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private val docs =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    smithy4s.http4s.swagger.docs[IO](smithy4s.hello.HelloWorldService)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def getAll(local: IOLocal[Option[RequestInfo]]): Resource[IO, HttpRoutes[IO]] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val getRequestInfo: IO[RequestInfo] = local.get.flatMap {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      case Some(value) =&gt; IO.pure(value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      case None =&gt; IO.raiseError(new IllegalAccessException(&quot;Tried to access the value outside of the lifecycle of an http request&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    smithy4s.http4s.SimpleRestJsonBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .routes(new HelloWorldServiceImpl(getRequestInfo))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .map { routes =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Middleware.withRequestInfo(routes &lt;+&gt; docs, local)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here we are creating our routes (with swagger docs) and passing them to our middleware. The result of applying the Middleware
is our final routes.</p><p>We also turn our <code>IOLocal</code> into an <code>IO[RequestInfo]</code> for the <code>HelloWorldServiceImpl</code>. We do this because the service implementation
does not need to know that the value is coming from an <code>IOLocal</code> or that the value is optional (since it will always be populated by
our middleware). Doing it this way allows us to reduce the complexity in the service implementation.</p><p>Finally, we create our main class and construct the http4s server.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import cats.effect.IOApp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.comcast.ip4s._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.http4s.ember.server.EmberServerBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object Main extends IOApp.Simple {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def run: IO[Unit] = IOLocal(Option.empty[RequestInfo]).flatMap { local =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Routes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .getAll(local)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .flatMap { routes =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EmberServerBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .default[IO]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .withHost(host&quot;localhost&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .withPort(port&quot;9000&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .withHttpApp(routes.orNotFound)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .useForever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Notice that we create the <code>IOLocal</code> with <code>Option.empty[RequestInfo]</code>. This is because <code>IOLocal</code> requires a value
to be constructed. However, this value will never be used in practice. This is because we are setting the value in
the middleware on every request prior to the request being handled by our <code>HelloWorldService</code> implementation.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="testing-it-out">Testing it out<a class="hash-link" href="#testing-it-out" title="Direct link to heading">â€‹</a></h3><p>With the above in place, we can run our application and test it out.</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X &#x27;POST&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;http://localhost:9000/Test&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &#x27;User-Agent: Chrome/103.0.0.0&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &#x27;Content-Type: application/json&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Running this <code>curl</code> will cause the following to print out to the console:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">REQUEST_INFO: RequestInfo(Some(application/json),Some(Chrome/103.0.0.0))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="alternative-methods">Alternative Methods<a class="hash-link" href="#alternative-methods" title="Direct link to heading">â€‹</a></h2><p>If you are working with a tagless <code>F[_]</code> rather than <code>IO</code> directly, you may want to check out Chris Davenport&#x27;s <a href="https://github.com/davenverse/fiberlocal/" target="_blank" rel="noopener noreferrer">implementation
of FiberLocal</a>.</p><p>You can also use <code>Kleisli</code> to accomplish the same things we showed in this tutorial and you are welcome to do so if you prefer that.
We opted to show an example with <code>IOLocal</code> since it allows users to use <code>IO</code> directly, without monad transformers, which many
users will be more comfortable with. Similarly, you could use <code>Local</code> from cats-mtl or probably a variety of other approaches.
We recommend you use whatever fits the best with your current application design.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/disneystreaming/smithy4s/edit/main/modules/docs/src/06-guides/extract-request-info.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/smithy4s/docs/design/services"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Services and endpoints</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-iolocal" class="table-of-contents__link toc-highlight">What is IOLocal?</a></li><li><a href="#example-implementation" class="table-of-contents__link toc-highlight">Example Implementation</a><ul><li><a href="#smithy-spec" class="table-of-contents__link toc-highlight">Smithy Spec</a></li><li><a href="#service-implementation" class="table-of-contents__link toc-highlight">Service Implementation</a></li><li><a href="#middleware" class="table-of-contents__link toc-highlight">Middleware</a></li><li><a href="#wiring-it-together" class="table-of-contents__link toc-highlight">Wiring it Together</a></li><li><a href="#testing-it-out" class="table-of-contents__link toc-highlight">Testing it out</a></li></ul></li><li><a href="#alternative-methods" class="table-of-contents__link toc-highlight">Alternative Methods</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/smithy4s/docs/overview/intro">Get Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/disneystreaming/smithy4s" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Disney Streaming</div></div></div></footer></div>
<script src="/smithy4s/assets/js/runtime~main.6c96914a.js"></script>
<script src="/smithy4s/assets/js/main.5e422d53.js"></script>
</body>
</html>